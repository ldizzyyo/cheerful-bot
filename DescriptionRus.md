# Введение #

Дети как то завели разговор о том, что хорошо бы сделать робота, чтоб не летал где-то далеко, а ползал под ногами.
Оказалось что это не только познавательно, но и интересно.
Платформой была выбрана Arduino, как наиболее распространенная и имеющая больше всего библиотек. Код под нее пишется просто, а отлаживается в основном по последовательному порту, миганием светодиодов, издаванием звуков и, если есть, выводом на LCD. Забегая вперед, скажу что у робота на борту есть говорящий модуль, так что я пускал через него некоторые цифры и сообщения.
Основные модули были куплены на www.goodluckbuy.com, некоторые уже были в закромах, а некоторые я собрал сам. В любом случае, я написал  аналоги для того, что было не закуплено непосредственно для робота.

# Детальное описание #

## Механическая часть ##

В целом, робот собран на небольших пластмассовых гусеничных шасси с двумя моторами, питаемыми через 6V BEC от 7.4V LiPo. Моторы управляются ШИМ через H-bridge.

## Мозги ##

Мозг робота - Arduino Nano, питаемая непосредственно от LiPo через Vin, и раздающая 5V остальным модулям. Arduino вставляется в маленькую монтажную плату, куда втыкаются сигнальные провода и питания модулей. Это оказалось очень удобно и ничего пока не вываливается (правда, соединенительные провода пришлось делать самому).

## Воспроизведение звуков ##

Для проигрывания звуков использован Wave модуль, способный проигрывать WAV файлы в формате PCM Mono и частотой дискретизации до 22kHz. Файлы читаются через SD модуль с SD карты, отформатированной в FAT16. Поскольку выход Wave модуля очень слабый (его еле слышно даже в наушниках), пришлось спаять усилитель на LM386. Но делать его самому вовсе не требуется - его можно вытащить откуда-нибудь, или купить то, что я написал ниже в списке деталей.

## Обнаружение препятствий ##

Для того чтобы робот казался более "живым", одной речи мало - надо еще и "разумное" поведение. Для самостоятельного движения на роботе стоит ультразвуковой радар (сонар), такой, какой мы обычно используем на коптерах для поддержания высоты и автоматической посадки. С ним связаны несколько глюков и фундаментальных проблем, о которых будет написано далее, но в целом он работает вполне удовлетворительно.

## Управление роботом ##

В ручном режиме робот управляется аж двумя путями: через ИК-пульт и через Bluetooth.
В качестве пульта выбран валявшийся поблизости пульт от RGB лампы и еще один непонятно от чего. В принципе можно использовать любой пульт при соблюдении двух условий: несущая частота пульта совпадает частотой ИК приемника (чаще используется 38kHz, но бывают исключения) и Вы произведете определение кодов кнопок и забьете их в программу Arduino вместо команд используемых мною двух пультов. Имейте ввиду, что с некоторыми редкими пультами библиотека декодирования ИК не может работать вообще.

Последовательный порт Bluetooth на скорости 115200 позволяет управлять роботом с компьютера и (та-да!) с мобильного телефона (например, на Android, но под iPhone и Java ME тоже можно написать). Приемник Bluetooth продается настроенным на другую скорость, так что воспользуйтесь инструкциями в Internet для установки его скорости в 115200. Команды, понимаемые роботом: включить/выключить обнаружение препятствий, установка скорости каждого из моторов, выключение моторов, блокирование отладочных сообщений, перезагрузка.

Для управление роботом с Android-телефона была написана (фактически за вечер, но потом еще вечер оттачивалась) простенькая программа. За основу была взята blu\_car  (Blu Car; Copyright (C) 2011 Eirik Taylor), в которой немного изменен UI а переделан способ управления. Робот управляется наклонами телефона (через акселлерометры), когда палец касается большой экранной кнопки. Есть кнопка остановки и включения/выключения режима обнаружения препятствий. Тестировалась программа на Samsung Galaxy i5500 под Android 2.1.1.

## Датчик света ##

На роботе есть датчик освещенности на фоторезисторе, который почти никак не используется. Единственное его применение - если робота оставить включенным, но неподвижными в полной темноте, он начинает играть тихую печальную мелодию ("Кристальная грусть"; Copyright Владимир Крайнов).

## Программа робота ##

Вот тут была славная битва! То памяти под переменные не хватает, то хип со стеком пересекаются... В конце концов отключил один из буферов чтения SD-карты и вынес все строки в EEPROM. Больше память не беспокоила :-)

Наиболее интересная часть программы - объезд препятствий - сделана необычно. Если робот засекает на некотором расстоянии что-то, он останавливается и, поворачиваясь, сканирует переднюю полусферу, а затем едет в направлении наибольшего свободного пути. Если при сканировании окажется, что в этом направлении путь свободен дальше определенной границы, робот сразу едет туда. Если вся передняя полусфера заблокирована, робот продолжает сканировать заднюю полусферу.

Если же препятствие очень близко и может препятствовать развороту, робот попытается сдать назад. Если "препятствие" движется за ним (надвигается любопытный кот, например), то робот развернется и поедет в обратную сторону.

В отладочном режиме (включается и ИК-пульта) робот голосом произносит расстояния, замеренные при сканировании.

В программе использованы библиотеки:

  * IRremote для декодирования ИК-команд (Copyright 2009 Ken Shirriff),
  * WaveHC/WaveUtil для воспроизведения звука и чтения SD-карты (Copyright (C) 2008 by William Greiman).

## Звуковое оформление ##

Робот при движении активно и бодро шумит. У него есть свои звуки под разгон и разную интенсивность торможения и поворотов. Равномерное движение происходит под бодрую мелодию. А о своих проблемах от говорит человеческим голосом :-) Все звуки записаны на SD и есть
в архиве.

## Easter eggs ##

Если робота оградить со всех сторон, он, когда это "поймет", кое-что отмочит :-)

## Известные глюки ##

1. Ультразвук не отражается от мягких предметов (занавески, например). Если он падает на гладкую поверхность под острым углом, эхо не попадает в приемник, а если и попадает, то после долгих блужданий и отражений, показывая нереально большое расстояние. Для решения этого буду ставить ИК-датчики ближнего действия (до 20 см.).

2. Bluetooth иногда затыкается. Я вроде бы поборол это, отключив на время прием информации с робота, но в будущих версиях программы надо будет с этим побороться.

3. Не каждая SD карточка работает с этими SD модулями. Мне пришлось перебрать полдесятка карт прежде чем я нашел одну совместимую.

## Дальнейшие планы ##

1. Переделать программу для Android. Сделать прием расстояния и т.д. от робота для отображения на экране, плюс еще несколько задумок. Сделать режим управления без использования датчика наклона, только касанием.

2. Поставить ИК-датчики расстояния близкого действия (5-15 см.) Они должны помочь роботу избегать тупиков с гладкими (невидимыми для ультразвукового радара) стенами.

3. Может быть поставить гироскоп для определения действительного угла поворота робота. Иногда ему попадаются гладкие поверхности или мелкие предметы, и на них он разворачивается немного не так, как должен.

4. Поставить FPV и XBee-модем вместо Bluetooth и отдать детям. А вот XBee можно соединять с телефоном уже по Bluetooth.

<a href='http://www.youtube.com/watch?feature=player_embedded&v=hglKhXwMHcs' target='_blank'><img src='http://img.youtube.com/vi/hglKhXwMHcs/0.jpg' width='425' height=344 /></a>